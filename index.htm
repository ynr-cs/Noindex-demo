<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODPT ID Hunter for BusNavi</title>
    <style>
        body { font-family: "Consolas", "Monaco", sans-serif; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        h1 { color: #4ec9b0; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* 入力エリア */
        .search-area { margin-bottom: 20px; }
        input { background: #252526; border: 1px solid #3e3e42; color: white; padding: 10px; width: 300px; }
        button { background: #0e639c; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        button:hover { background: #1177bb; }

        /* 2カラムレイアウト */
        .container { display: flex; gap: 20px; }
        .list-pane { flex: 1; border: 1px solid #333; padding: 10px; height: 80vh; overflow-y: auto; background: #252526; }
        .detail-pane { flex: 2; border: 1px solid #333; padding: 10px; height: 80vh; overflow-y: auto; background: #1e1e1e; }

        /* アイテム表示 */
        .stop-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
        .stop-item:hover { background: #2a2d2e; }
        .stop-item.active { background: #094771; }
        
        .section-title { color: #ce9178; margin-top: 20px; font-weight: bold; font-size: 1.1em; }
        .id-box { background: #000; padding: 10px; margin: 5px 0; border: 1px solid #333; font-size: 0.85em; word-break: break-all; display: flex; justify-content: space-between; align-items: center; }
        
        .copy-btn { background: #333; color: #fff; border: 1px solid #555; padding: 2px 8px; font-size: 0.8em; cursor: pointer; margin-left: 10px; }
        .copy-btn:active { background: #4ec9b0; color: #000; }

        .route-card { border: 1px solid #444; padding: 10px; margin-bottom: 10px; background: #2d2d2d; }
        .route-title { font-size: 1.1em; color: #9cdcfe; font-weight: bold; }
        .route-dest { color: #dcdcaa; font-size: 0.9em; }
        .loading { color: #569cd6; }
    </style>
</head>
<body>

    <h1>ODPT ID 採掘ツール (BusNavi開発用)</h1>
    <div class="search-area">
        <input type="text" id="searchInput" value="洋光台駅" placeholder="バス停名 (例: 洋光台, 上大岡)">
        <button onclick="searchStops()">検索</button>
    </div>

    <div class="container">
        <!-- 左側：バス停リスト -->
        <div class="list-pane" id="stopList">
            <div style="padding:10px; color:#666;">ここに検索結果が出ます</div>
        </div>

        <!-- 右側：詳細（ID一覧） -->
        <div class="detail-pane" id="detailArea">
            <div style="padding:10px; color:#666;">左のリストからバス停を選んでください</div>
        </div>
    </div>

    <script>
        const API_KEY = "ey01nwehtybra9q2yzsjvskb5scs53wzne32hhgm1g7reh76oj1nudg8rpavr7ui";
        const API_BASE = "https://api.odpt.org/api/v4";
        const OPERATOR = "odpt.Operator:YokohamaMunicipal";

        // コピー機能
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("コピーしました:\n" + text);
            });
        }

        // 1. バス停検索
        async function searchStops() {
            const input = document.getElementById('searchInput').value;
            const listArea = document.getElementById('stopList');
            listArea.innerHTML = '<div class="loading">検索中...</div>';

            try {
                const url = `${API_BASE}/odpt:BusstopPole?odpt:operator=${OPERATOR}&dc:title=${encodeURIComponent(input)}&acl:consumerKey=${API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();

                listArea.innerHTML = "";
                if (data.length === 0) {
                    listArea.innerHTML = "見つかりませんでした";
                    return;
                }

                data.forEach(stop => {
                    const div = document.createElement('div');
                    div.className = 'stop-item';
                    div.innerHTML = `
                        <strong>${stop['dc:title']}</strong><br>
                        <small>ID末尾: ...${stop['owl:sameAs'].split('.').pop()}</small>
                    `;
                    div.onclick = () => {
                        // 選択状態のスタイル
                        document.querySelectorAll('.stop-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        showDetails(stop);
                    };
                    listArea.appendChild(div);
                });

            } catch (e) {
                listArea.innerHTML = "エラー: " + e.message;
            }
        }

        // 2. 詳細表示 & 系統ID解析
        async function showDetails(stop) {
            const detailArea = document.getElementById('detailArea');
            const stopId = stop['owl:sameAs'];
            const routeIds = stop['odpt:busroutePattern'] || [];

            detailArea.innerHTML = `
                <h2 style="margin-top:0;">${stop['dc:title']}</h2>
                
                <div class="section-title">■ このバス停のID (stopId)</div>
                <div style="font-size:0.8em; color:#888; margin-bottom:5px;">設定ファイルの stopId に使います</div>
                <div class="id-box">
                    <span style="color:#ce9178;">"${stopId}"</span>
                    <button class="copy-btn" onclick="copyToClipboard('${stopId}')">COPY</button>
                </div>

                <div class="section-title">■ 通過する系統のID (routeIds)</div>
                <div style="font-size:0.8em; color:#888; margin-bottom:5px;">設定ファイルの routeIds 配列に使います。必要な行き先のものをコピーしてください。</div>
                <div id="routeContainer"><div class="loading">系統情報を解析中... (${routeIds.length}件)</div></div>
            `;

            // 系統情報を個別に取得して、中身（行き先・系統名）を表示する
            const routeContainer = document.getElementById('routeContainer');
            let routeHtml = "";

            // API負荷軽減のため5件ずつ処理
            // ※本番アプリではないので、ここでは単純に逐次取得します
            for (const rid of routeIds) {
                try {
                    // BusroutePattern APIを叩いて、名前と方向を確認
                    const url = `${API_BASE}/odpt:BusroutePattern?owl:sameAs=${encodeURIComponent(rid)}&acl:consumerKey=${API_KEY}`;
                    const res = await fetch(url);
                    const rData = await res.json();

                    if (rData.length > 0) {
                        const route = rData[0];
                        const title = route['dc:title'] || "不明な系統"; // 例: 111系統
                        const direction = route['odpt:direction'] || "方向不明"; // 例: 上大岡駅前行
                        // directionがコード値の場合があるので、noteやdestinationSignも確認したいが、
                        // BusroutePatternにはdestinationSignがないことが多い。
                        // 傾向として、IDの中にヒントがある場合も。
                        
                        routeHtml += `
                            <div class="route-card">
                                <div class="route-title">${title}</div>
                                <div class="route-dest">方向データ: ${direction}</div>
                                <div class="id-box">
                                    <span style="color:#9cdcfe;">"${rid}"</span>
                                    <button class="copy-btn" onclick="copyToClipboard('${rid}')">COPY</button>
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            if (routeHtml === "") {
                routeContainer.innerHTML = "系統情報が取得できませんでした。";
            } else {
                routeContainer.innerHTML = routeHtml;
            }
        }
    </script>
</body>
</html>

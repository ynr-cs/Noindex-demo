<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- スマホ対応 -->
    <title>横浜市営バス 時刻表検索（修正版）</title>
    <style>
        body { font-family: sans-serif; padding: 15px; line-height: 1.6; }
        h1 { font-size: 1.2em; color: #003366; }
        input, button { padding: 10px; font-size: 16px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        button { background-color: #0055aa; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .bus-stop { margin-bottom: 8px; padding: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; }
        .bus-stop:hover { background-color: #eef; border-color: #0055aa; }
        .time-row { border-bottom: 1px solid #eee; padding: 5px 0; display: flex; justify-content: space-between; }
        .loading { color: #666; font-style: italic; }
        .error { color: red; background: #ffeeee; padding: 10px; }
    </style>
</head>
<body>
    <h1>横浜市営バス 時刻表（抽出モード）</h1>
    
    <input type="text" id="stopNameInput" value="横浜駅前" placeholder="バス停名を入力">
    <button id="searchBtn">バス停を検索</button>

    <div id="resultArea"></div>

    <script>
        const API_KEY = "ey01nwehtybra9q2yzsjvskb5scs53wzne32hhgm1g7reh76oj1nudg8rpavr7ui";
        const API_BASE = "https://api.odpt.org/api/v4";
        const OPERATOR_ID = "odpt.Operator:YokohamaMunicipal";

        const resultArea = document.getElementById('resultArea');

        // 1. バス停検索
        async function searchBusStop() {
            const stopName = document.getElementById('stopNameInput').value;
            resultArea.innerHTML = '<div class="loading">バス停を検索中...</div>';

            try {
                const url = `${API_BASE}/odpt:BusstopPole?odpt:operator=${OPERATOR_ID}&dc:title=${stopName}&acl:consumerKey=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.length === 0) {
                    resultArea.innerHTML = '<div class="error">バス停が見つかりませんでした。<br>例：「横浜駅前」「本牧」など正確に入力してください。</div>';
                    return;
                }

                // 検索結果表示
                let html = `<h3>「${stopName}」の検索結果 (${data.length}件)</h3>`;
                html += `<p style="font-size:0.9em; color:#666;">※見たい乗り場を選んでください</p>`;
                
                data.forEach(stop => {
                    // 系統情報の配列を取得（なければ空配列）
                    const routeIds = stop['odpt:busroutePattern'] || [];
                    
                    // HTML生成
                    html += `<div class="bus-stop" onclick="loadTimetable('${stop['owl:sameAs']}', '${stop['dc:title']}', '${routeIds.join(',')}')">
                        <strong>${stop['dc:title']}</strong> 
                        <span style="font-size:0.8em; color:#555;">(ID: ${stop['odpt:busstopPoleNumber'] || '-'})</span>
                        <br>
                        <small>乗り入れ系統数: ${routeIds.length}</small>
                    </div>`;
                });
                
                resultArea.innerHTML = html;

            } catch (error) {
                console.error(error);
                resultArea.innerHTML = `<div class="error">エラーが発生しました: ${error.message}</div>`;
            }
        }

        // 2. 時刻表データの取得と抽出
        async function loadTimetable(poleId, stopName, routeIdsStr) {
            // routeIdsStr はカンマ区切りの文字列なので配列に戻す
            const routeIds = routeIdsStr ? routeIdsStr.split(',') : [];

            if (routeIds.length === 0) {
                resultArea.innerHTML = `<div class="error">このバス停を通る系統データが見つかりませんでした。</div>`;
                return;
            }

            resultArea.innerHTML = `<div class="loading">
                時刻データを取得・解析中...<br>
                対象系統数: ${routeIds.length}件<br>
                (データ量が多いので数秒かかります)
            </div>`;

            try {
                // 全系統のデータを格納する配列
                let allTimetables = [];

                // 系統ごとにループして「odpt:BusTimetable」を取得
                // ※本来はPromise.allを使うべきですが、API制限回避のため今回は1つずつ処理します（簡易実装）
                // ※とりあえず最初の3系統だけ取得してみます（全部やると重すぎるため）
                const targetRoutes = routeIds.slice(0, 5); 

                for (const routeId of targetRoutes) {
                    // 今日の曜日判定（簡易版）
                    const day = new Date().getDay(); // 0:日, 6:土
                    let calendar = "Weekday";
                    if (day === 0) calendar = "Holiday";
                    else if (day === 6) calendar = "Saturday";

                    // 運行ごとの時刻表を取得
                    const url = `${API_BASE}/odpt:BusTimetable?odpt:operator=${OPERATOR_ID}&odpt:busroutePattern=${routeId}&odpt:calendar=odpt.Calendar:${calendar}&acl:consumerKey=${API_KEY}`;
                    
                    const res = await fetch(url);
                    const buses = await res.json();

                    // 各バスの運行データから、このバス停(poleId)の時間を探す
                    buses.forEach(bus => {
                        const timeObjs = bus['odpt:busTimetableObject'];
                        
                        // このバス停が含まれているか検索
                        const targetStop = timeObjs.find(t => t['odpt:busstopPole'] === poleId);
                        
                        if (targetStop && targetStop['odpt:departureTime']) {
                            allTimetables.push({
                                time: targetStop['odpt:departureTime'],
                                dest: bus['odpt:destinationSign'] || targetStop['odpt:destinationSign'] || '行き先不明',
                                route: bus['dc:title'] || '系統不明' // バスの系統名
                            });
                        }
                    });
                }

                // 時間順に並び替え
                allTimetables.sort((a, b) => a.time.localeCompare(b.time));

                // 結果表示
                if (allTimetables.length === 0) {
                    resultArea.innerHTML = `<div class="error">時刻データが見つかりませんでした。<br>（データ未整備または運休の可能性があります）</div>`;
                    return;
                }

                let html = `<h3>${stopName} 発車予定</h3>`;
                html += `<p>表示中のカレンダー: ${new Date().getDay() === 0 ? '休日' : (new Date().getDay() === 6 ? '土曜' : '平日')}</p>`;
                
                allTimetables.forEach(item => {
                    html += `<div class="time-row">
                        <strong style="font-size:1.2em;">${item.time}</strong>
                        <span>${item.route} : ${item.dest}</span>
                    </div>`;
                });

                // 全部取得していない場合の注記
                if (routeIds.length > 5) {
                    html += `<p style="color:red; font-size:0.8em;">※データ量が多いため、一部の系統のみ表示しています。</p>`;
                }

                resultArea.innerHTML = html;

            } catch (error) {
                console.error(error);
                resultArea.innerHTML = `<div class="error">データ取得中にエラー: ${error.message}</div>`;
            }
        }

        document.getElementById('searchBtn').addEventListener('click', searchBusStop);
    </script>
</body>
</html>
